name: CI/CD Pipeline

on:
  push:
    branches:
      - staging  # Trigger deployment to staging
  create:
    tags:
      - 'v*'     # Trigger deployment to prod on tag (e.g., v1.0)

jobs:
  # JOB 1: CI - Build and Test
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Tests
        run: |
          pytest

  # JOB 2: Deploy to Staging
  deploy-staging:
    needs: build-and-test
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2 Staging
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Navigate to folder (clone if empty, pull if exists)
            if [ ! -d "/var/www/flask-staging/.git" ]; then
              git clone -b staging https://github.com/jatinggg/flask_Practice.git /var/www/flask-staging
            else
              cd /var/www/flask-staging
              git pull origin staging
            fi
            
            cd /var/www/flask-staging
            
            # Create Virtual Env & Install Deps
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt
            
            # Create .env file dynamically
            echo "MONGO_URI=${{ secrets.MONGO_URI }}" > .env
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
            
            # Start/Restart Application (Using simple nohup for staging demo)
            # Kill existing process on port 8000 if exists
            fuser -k 8000/tcp || true
            # Run with Gunicorn on port 8000
            nohup gunicorn -w 2 -b 0.0.0.0:8000 app:app > log.txt 2>&1 &

  # JOB 3: Deploy to Production
  deploy-production:
    needs: build-and-test
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2 Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Navigate to folder
            if [ ! -d "/var/www/flask-prod/.git" ]; then
              git clone https://github.com/jatinggg/flask_Practice.git /var/www/flask-prod
            else
              cd /var/www/flask-prod
              git fetch --tags
              git checkout ${{ github.ref_name }}
              git pull origin main
            fi
            
            cd /var/www/flask-prod
            
            # Setup Env
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt
            
            # Secrets
            echo "MONGO_URI=${{ secrets.MONGO_URI }}" > .env
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
            
            # Kill existing process on port 8080 (Prod runs on different port)
            fuser -k 8080/tcp || true
            nohup gunicorn -w 4 -b 0.0.0.0:8080 app:app > prod_log.txt 2>&1 &
