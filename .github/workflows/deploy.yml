name: Deploy to EC2 (Flask App CI/CD)

on:
  push:
    branches:
      - main
      - staging

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run Tests
      run: |
        if [ -d tests ] || ls test_*.py >/dev/null 2>&1; then
          pytest -q
        else
          echo "No tests found; skipping pytest"
        fi

    - name: Copy code to EC2
      if: success()
      uses: appleboy/scp-action@v1
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        source: ./
        target: ~/flask_app_temp

    - name: Deploy to correct folder and set APP_ENV
      if: success()
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          echo "GitHub ref name: ${{ github.ref_name }}"
          # decide target and APP_ENV based on branch
          if [ "${{ github.ref_name }}" = "main" ]; then
            TARGET="/var/www/html"
            APP_ENV="production"
          else
            TARGET="/var/www/html/staging"
            APP_ENV="staging"
          fi

          echo "Deploy target: $TARGET"
          sudo mkdir -p "$TARGET"
          # remove old files (be careful if you have anything else in /var/www/html)
          sudo rm -rf "${TARGET:?}"/*
          # copy uploaded files into target
          sudo cp -r ~/flask_app_temp/* "$TARGET/"
          # set permissions so nginx (www-data) can read (optional)
          sudo chown -R www-data:www-data "$TARGET"
          # write a minimal .env file with APP_ENV so your app can detect env
          echo "APP_ENV=$APP_ENV" | sudo tee "$TARGET/.env" > /dev/null
          # restart nginx to pick up changes
          sudo systemctl restart nginx
          echo "Deployment finished for branch: ${{ github.ref_name }} (APP_ENV=$APP_ENV)"
